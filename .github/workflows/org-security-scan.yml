name: centralized-security-scan

on:
  workflow_dispatch: {}     # Run manually from Actions tab for governance scans

permissions:
  contents: read
  packages: read

jobs:
  security-scan:
    runs-on: ubuntu-latest

    # üîπ List all target repositories (multi-repo scanning support)
    strategy:
      matrix:
        repo:
          - AristocratTechnologiesInc/gdk
          - pradeepkumboju/v3
          # Add more repos here as needed

    steps:
      # -------------------------------
      # 1Ô∏è‚É£ Checkout the central workflow repo
      # -------------------------------
      - name: Checkout central repo (this repo)
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          mkdir -p git-repos
          echo "Workspace prepared under $(pwd)/git-repos"

      # -------------------------------
      # 2Ô∏è‚É£ Extract repo name
      # -------------------------------
      - name: Extract repo name
        id: extract_repo
        run: echo "repo_name=$(basename ${{ matrix.repo }})" >> $GITHUB_OUTPUT

      # -------------------------------
      # 3Ô∏è‚É£ Checkout target repository
      # -------------------------------
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.TARGET_TOKEN }}   # ‚úÖ PAT with cross-repo access
          path: git-repos/${{ steps.extract_repo.outputs.repo_name }}

      - name: Verify target repo structure
        run: |
          echo "Target repository checked out:"
          ls -ltr git-repos/${{ steps.extract_repo.outputs.repo_name }}

      # -------------------------------
      # 4Ô∏è‚É£ Setup Node.js environment
      # -------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.17.0'
          registry-url: https://npm.pkg.github.com
          scope: '@aristocrattechnologiesinc'

      - name: Authenticate npm for GitHub Packages
        run: |
          echo "@aristocrattechnologiesinc:registry=https://npm.pkg.github.com" > ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.TARGET_TOKEN }}" >> ~/.npmrc
          echo "‚úÖ NPM authentication configured"

      # -------------------------------
      # 5Ô∏è‚É£ Dependency Scans (npm & pnpm)
      # -------------------------------
      - name: Run dependency vulnerability scans
        run: |
          cd git-repos/${{ steps.extract_repo.outputs.repo_name }}
          mkdir -p reports
          echo "Running npm audit..."
          npm install --legacy-peer-deps || true
          npm audit --json > reports/npm-audit.json || true
          echo "Running pnpm audit..."
          if command -v pnpm >/dev/null 2>&1; then
            pnpm audit --json > reports/pnpm-audit.json || true
          else
            echo "pnpm not found, skipping pnpm audit"
          fi

      # -------------------------------
      # 6Ô∏è‚É£ Secret Scanning
      # -------------------------------
      - name: Secret scanning with detect-secrets
        run: |
          cd git-repos/${{ steps.extract_repo.outputs.repo_name }}
          pip install detect-secrets
          detect-secrets scan > reports/secret-scan.json || true
          echo "‚úÖ Secret scan completed"

      # -------------------------------
      # 7Ô∏è‚É£ Container/Image Scanning with Trivy
      # -------------------------------
      - name: Container scanning using Trivy
        run: |
          cd git-repos/${{ steps.extract_repo.outputs.repo_name }}
          mkdir -p reports
          if [ -f Dockerfile ]; then
            echo "Running Trivy image scan..."
            trivy fs . --format json --output reports/trivy-scan.json || true
          else
            echo "No Dockerfile found, skipping container scan"
          fi

      # -------------------------------
      # 8Ô∏è‚É£ SonarCloud Scan
      # -------------------------------
      - name: SonarCloud Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          cd git-repos/${{ steps.extract_repo.outputs.repo_name }}
          echo "Starting SonarCloud scan..."
          sonar-scanner \
            -Dsonar.projectKey=${{ steps.extract_repo.outputs.repo_name }} \
            -Dsonar.organization=aristocrattechnologiesinc \
            -Dsonar.sources=. \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} || true

      # -------------------------------
      # 9Ô∏è‚É£ Upload all reports as artifacts
      # -------------------------------
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ steps.extract_repo.outputs.repo_name }}
          path: git-repos/${{ steps.extract_repo.outputs.repo_name }}/reports/
          retention-days: 7

      # -------------------------------
      # üîü Cleanup (optional)
      # -------------------------------
      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf git-repos
          echo "üßπ Cleanup completed"
